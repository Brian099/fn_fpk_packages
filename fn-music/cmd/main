#!/bin/bash

APP_ROOT="$TRIM_APPDEST/app/server"
PID_FILE="$TRIM_PKGVAR/app.pid"
LOG_FILE="$TRIM_PKGVAR/app.log"
PYTHON_EXEC="python3"

# Ensure lib is in python path
export PYTHONPATH="$APP_ROOT/lib:$PYTHONPATH"
export MUSIC_LIBRARY_PATH="$TRIM_PKGVAR"
export PORT="${TRIM_SERVICE_PORT:-23237}"
export LOG_PATH="$LOG_FILE"

start_process() {
    if [ -f "$PID_FILE" ]; then
        if kill -0 $(cat "$PID_FILE") 2>/dev/null; then
            echo "Process already running."
            return 0
        else
            rm "$PID_FILE"
        fi
    fi

    # Start the application
    nohup $PYTHON_EXEC "$APP_ROOT/app.py" >> "$LOG_FILE" 2>&1 &
    echo $! > "$PID_FILE"
    return 0
}

stop_process() {
    if [ -f "$PID_FILE" ]; then
        PID=$(cat "$PID_FILE")
        if kill -0 "$PID" 2>/dev/null; then
            kill "$PID"
            # Wait for process to exit
            for i in {1..10}; do
                if ! kill -0 "$PID" 2>/dev/null; then
                    break
                fi
                sleep 0.5
            done
            # Force kill if still running
            if kill -0 "$PID" 2>/dev/null; then
                kill -9 "$PID"
            fi
        fi
        rm "$PID_FILE"
    fi
    return 0
}

status_process() {
    if [ -f "$PID_FILE" ]; then
        if kill -0 $(cat "$PID_FILE") 2>/dev/null; then
            return 0
        fi
    fi
    return 1
}

case $1 in
start)
    start_process
    exit $?
    ;;
stop)
    stop_process
    exit $?
    ;;
status)
    if status_process; then
        exit 0
    else
        exit 3
    fi
    ;;
*)
    exit 1
    ;;
esac
