#!/bin/bash

LOG_FILE="${TRIM_PKGVAR}/info.log"

log_msg() {
  echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" >>${LOG_FILE}
}

start_process() {
  if status; then
    return 0
  fi

  log_msg "Starting process skipped (musicwave has no background service)"
  return 0
}

stop_process() {
  log_msg "Stopping musicwave..."

  # Find running instances of sites_backend.sh
  # Using pgrep -f to match the command line including arguments/script path
  PIDS=$(pgrep -f "sites_backend.sh")

  if [ -n "$PIDS" ]; then
    log_msg "Found active backend tasks (PIDs: $PIDS). Terminating..."

    # Iterate over PIDs to kill children (ffmpeg/ffprobe) first
    for PID in $PIDS; do
        # Kill child processes (ffmpeg, ffprobe started by this script)
        pkill -P "$PID"
    done

    # Kill the scripts themselves
    kill -TERM $PIDS 2>/dev/null
    
    # Wait briefly
    sleep 1
    
    # Force kill if still running
    # Re-check PIDs to avoid errors
    REMAINING=$(pgrep -f "sites_backend.sh")
    if [ -n "$REMAINING" ]; then
        echo "$REMAINING" | xargs kill -9 2>/dev/null
    fi

    log_msg "Backend tasks terminated."
  else
    log_msg "No active backend tasks found."
  fi

  return 0
}

status() {
  return 0
}

case $1 in
  start)
    # run start command. exit 0 if success, exit 1 if failed
    start_process
    ;;
  stop)
    # run stop command. exit 0 if success, exit 1 if failed
    stop_process
    ;;
  status)
    # check application status command. exit 0 if running, exit 3 if not running
    if status; then
      exit 0
    else
      exit 3
    fi
    ;;
  *)
    exit 1
    ;;
esac
